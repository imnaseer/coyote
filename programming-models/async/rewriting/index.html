<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://microsoft.github.io/coyote/programming-models/async/rewriting/">
    <link rel="shortcut icon" href="/coyote/img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Rewriting binaries - Coyote</title>
    <link href="/coyote/css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="/coyote/css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="/coyote/css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="/coyote/css/highlight.css">
    <link href="../../../css/main.css" rel="stylesheet">
    <link href="../../../css/player-controls.css" rel="stylesheet">
    <link href="../../../css/syntax.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="/coyote/js/jquery-3.2.1.min.js"></script>
    <script src="/coyote/js/bootstrap-3.3.7.min.js"></script>
    <script src="/coyote/js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '/coyote/';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Rewriting binaries", url: "#_top", children: [
          ]},
          {title: "Not supported", url: "#not-supported", children: [
          ]},
        ];

    </script>
    <script src="/coyote/js/base.js"></script>
      <script src="https://www.googletagmanager.com/gtag/js?id=UA-89203408-1"></script>
      <script src="https://consentdeliveryfd.azurefd.net/mscc/lib/v2/wcp-consent.js"></script>
      <script src="../../../assets/js/analytics.js"></script>
      <script src="../../../assets/js/plugins.js"></script>
      <script src="../../../assets/js/animate_trace.js"></script>
      <script src="../../../assets/js/animation.js"></script>
      <script src="../../../assets/js/progress_bar.js"></script>
      <script src="../../../assets/js/trace_model.js"></script>
      <script src="../../../assets/js/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>

<div id="cookie-banner"></div>


<div class="wrapper wm-page-content">
  <div class="container-fluid">
    <a name="_top"></a>
      

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../actors/overview/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../actors/overview/" class="btn btn-xs btn-link">
        Overview
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../interleavings/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../interleavings/" class="btn btn-xs btn-link">
        Improving coverage of fine-grained interleavings
      </a>
    </div>
    
  </div>

      

      <h2 id="rewriting-binaries">Rewriting binaries</h2>
<p><img alt="Rewriting is currently in-preview" src="https://img.shields.io/static/v1?style=flat&amp;color=red&amp;label=&amp;message=preview" /></p>
<p>The <a href="../overview/">asynchronous tasks programming model</a> shows how Coyote can control the concurrency
of asynchronous operations using the special Coyote Task types. You can choose to use this
programming model by modifying your code to use these Coyote Task types but this takes some effort
on your part. Instead, you can use the <a href="../../../tools/rewriting">coyote rewriting tool</a> which will
automatically rewrite your binaries in a way that they can then be used in <code>coyote test</code> runs.</p>
<p>This automatic rewriting currently supports rewriting the following constructs so they are testable
with <code>coyote test</code>:</p>
<ul>
<li><code>Task</code>, all methods except <code>ConfigureAwait</code> and <code>ContinueWith</code></li>
<li>C# lock statements and <code>Monitor</code> type.</li>
<li>Exception handlers</li>
</ul>
<p>Note that during testing coyote needs to be able to terminate a test iteration at any time in order
to support the <code>--max-steps</code> command line argument. This termination is done using a special coyote
<code>ExecutionCancelledException</code>. The problem is when your code contains one of the following:</p>
<pre><code class="language-c#">} catch {
} catch (Exception) {
} catch (RuntimeException) {
</code></pre>
<p>these will inadvertently catch the special Coyote exception, which then stops <code>--max-steps</code> from
working. The recommended fix is to add a <code>when (!(e is Microsoft.Coyote.RuntimeException))</code>
filter as shown in <a href="../../../tools/tester-requirements/">tester requirements</a>.</p>
<p>The good news is that <code>coyote rewrite</code> can take care of this for you automatically so you do not
need to modify any of your exception handlers.</p>
<h2 id="not-supported">Not supported</h2>
<p>The following concurrency constructs are not supported by <code>coyote rewrite</code>:</p>
<ul>
<li><code>Parallel</code> helper class.</li>
<li><code>System.Collections.Current.BlockingCollection</code></li>
<li><code>ThreadPool</code></li>
<li><code>Thread</code></li>
<li><code>ManualResetEvent</code>, <code>AutoResetEvent</code>, <code>SemaphoreSlim</code>, <code>Semaphore</code>, <code>SpinLock</code>, <code>SpinWait</code>, <code>ReaderWriterLock</code>, <code>Interlocked</code>, &hellip;</li>
<li>Essentially any form of concurrency control that is not listed in the supported list above
including native calls to Win32 API&rsquo;s that block the current thread or spawn new threads.</li>
<li><a href="https://github.com/dotnet/roslyn/blob/master/docs/features/task-types.md">Task-like types</a></li>
<li>Any .NET library that is a mixed-mode assembly.</li>
<li>Any .NET library type or method that uses any of the above, especially blocking IO like
<code>System.IO.Pipelines</code>, <code>System.IO.Channels</code>, etc.</li>
</ul>
<p>As you can see this is currently a long list, that will hopefully get shorter over time
as development continues on this feature.</p>

    <br>
      

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../actors/overview/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../actors/overview/" class="btn btn-xs btn-link">
        Overview
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../interleavings/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../interleavings/" class="btn btn-xs btn-link">
        Improving coverage of fine-grained interleavings
      </a>
    </div>
    
  </div>

      <br>
  </div>
</div>

<footer class="wm-page-content">
      <p>
        <a href="https://github.com/microsoft/coyote/"><i class="fa fa-github"></i>
GitHub</a>
      </p>

  

<section class="footer-join pt-40 pb-80">
  <div class="container-fluid">
    <div class="row text-center">
      <div class="col-sm-8 col-sm-offset-2">
      </div>
    </div>
    <div class="row">

   </div>
  </div>
</section>
<section class="footer-dark pt-60">
  <div class="container-fluid">
    <div class="row">
      <div class="hidden-xs col-sm-5 col-lg-6">
        <a href="" title="homepage" class="logo-footer">
          <img src="/coyote/assets/images/icon.png" alt="Coyote">
        </a>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Coyote</h4>
          <ul class="list-unstyled">

            <li><a href="/coyote/">Home</a></li>

            <li><a href="/coyote/overview/about">About</a></li>

          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Resources</h4>
          <ul class="list-unstyled">

            <li><a href="/coyote/get-started/install">Install</a></li>

            <li><a href="/coyote/get-started/using-coyote">Getting started</a></li>

          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Community</h4>
          <ul class="list-unstyled">

            <li><a href="https://github.com/microsoft/coyote" target="_blank">GitHub</a></li>

            <li><a href="https://gitter.im/microsoft/coyote" target="_blank">Gitter</a></li>

          </ul>
        </nav>
      </div>

    </div>

    <div class="row footnote pt-50 pb-20">
      <div class="col-sm-12">
        <hr>
      </div>
      <div class="col-sm-6">
        <ul class="list-unstyled list-inline footnote-copy">

          <li><a href="https://privacy.microsoft.com/en-us/privacystatement/" target="_blank">Privacy</a></li>

          <li><a href="https://www.microsoft.com/en-us/legal/intellectualproperty/copyright/default.aspx" target="_blank">Terms of Use</a></li>

          <li><a href="https://github.com/microsoft/coyote/blob/main/LICENSE" target="_blank">License</a></li>

          <li><a href="javascript:manageCookies()">Cookies</a></li>

        </ul>
      </div>
      <div class="col-sm-6 text-right footnote-copy">
        <ul class="list-unstyled list-inline">
          <li><span id="copyright"></span></li>
          <li><a href="https://www.microsoft.com/" target="_blank"><img class="img-responsive" src="/coyote/assets/images/microsoft-logo.svg?v=3" alt="Microsoft">&nbsp;</a></li>
        </ul>
      </div>
    </div>
  </div>
</section>
</footer>


<script type="text/javascript">
    $(document).ready(function () {
      $('table').each(function () {
        $(this).addClass("table");
        $(this).addClass("table-bordered");
        $(this).addClass("table-striped");
        $(this).addClass("table-condensed");
      });

    });
</script>

</body>
</html>